<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>China Auto Dashboard</title>
  <link rel="icon" href="https://img.icons8.com/emoji/48/automobile.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { background-color: #f8f9fa; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif; }
    header { background: #0d6efd; color: #fff; padding: 12px; text-align: center; font-size: 1.3rem; font-weight: 700; }
    th { background-color: #f1f3f5; }
    .rank-up { color: #dc3545; font-weight: bold; }
    .rank-down { color: #198754; font-weight: bold; }
    .spec-table-container { display: flex; flex-direction: row; }
    .spec-sidebar { width: 220px; background: #fff; border-right: 1px solid #dee2e6; overflow-y: auto; }
    .spec-content { flex: 1; padding: 1rem; }
    .sec-row th { background: #e9ecef; font-size: 1.1rem; }
    .item-col { width: 220px; background: #fff; font-weight: 500; }
  </style>
</head>
<body>
  <header>Autohome 車種別仕様比較</header>
  <div id="specs" class="container-fluid my-3">
    <div class="text-center text-secondary">CSV読込中...</div>
  </div>

  <script>
    const CSV_URL = "output/autohome/5714/config_5714.ja.csv";

    fetch(CSV_URL)
      .then(res => res.text())
      .then(text => {
        const target = document.getElementById("specs");
        const rows = Papa.parse(text.trim(), { skipEmptyLines: true }).data;

        if (!rows || !rows.length) {
          target.innerHTML = "<div class='text-danger'>CSVが空です。</div>";
          return;
        }

        // ✅ ヘッダー行を特定
        const headerIdx = rows.findIndex(r => r.some(v => /^項目(_ja)?$/.test((v || "").trim())));
        if (headerIdx === -1) {
          target.innerHTML = "<div class='text-danger'>ヘッダー行が見つかりません。</div>";
          return;
        }

        const headerRow = rows[headerIdx];
        const idxSecJa  = headerRow.findIndex(v => (v || "").trim() === "セクション_ja");
        const idxSec    = headerRow.findIndex(v => (v || "").trim() === "セクション");
        const secIdx    = (idxSecJa !== -1 ? idxSecJa : idxSec);
        const idxItemJa = headerRow.findIndex(v => (v || "").trim() === "項目_ja");
        const idxItem   = headerRow.findIndex(v => (v || "").trim() === "項目");
        const itemIdx   = (idxItemJa !== -1 ? idxItemJa : idxItem);

        if (secIdx === -1 || itemIdx === -1) {
          target.innerHTML = "<div class='text-danger'>必要な列（セクション_ja/項目_ja）が見つかりません。</div>";
          return;
        }

        const modelStart   = Math.max(secIdx, itemIdx) + 1;
        const modelHeaders = headerRow.slice(modelStart);
        const dataRows     = rows.slice(headerIdx + 1);

        const grouped = [];
        let currentSection = "";
        for (const r of dataRows) {
          const sec = (r[secIdx] || "").trim();
          if (sec && sec.toLowerCase() !== "nan") currentSection = sec;
          if (!currentSection) continue;
          const item = (r[itemIdx] || "").trim();
          if (!item || /^(セクション|セクション_ja|項目|項目_ja)$/i.test(item)) continue;
          const cols = r.slice(modelStart);
          if (!grouped.length || grouped[grouped.length - 1].section !== currentSection) {
            grouped.push({ section: currentSection, rows: [] });
          }
          grouped[grouped.length - 1].rows.push([item, ...cols]);
        }

        const thead = `<thead><tr><th style="min-width:180px;">項目</th>${modelHeaders.map(h => `<th>${h}</th>`).join("")}</tr></thead>`;

        let navHtml = "<div class='spec-sidebar p-2'>";
        for (const g of grouped) {
          const id = `sec_${g.section.replace(/\s+/g, "_")}`;
          navHtml += `<a href="#${id}" class="d-block py-1 text-decoration-none text-primary">${g.section}</a>`;
        }
        navHtml += "</div>";

        let tbody = "<tbody>";
        for (const g of grouped) {
          const id = `sec_${g.section.replace(/\s+/g, "_")}`;
          tbody += `<tr id="${id}" class="sec-row"><th colspan="${1 + modelHeaders.length}">▼ ${g.section}</th></tr>`;
          for (const row of g.rows) {
            const item = row[0] || "";
            const cells = row.slice(1).map(v => `<td style="white-space:pre-line;">${(v || "").replace(/^nan$/i,"")}</td>`).join("");
            tbody += `<tr><th class="item-col">${item}</th>${cells}</tr>`;
          }
        }
        tbody += "</tbody>";

        const tableHtml = `
          <div class="spec-table-container d-flex" style="max-height:80vh;">
            ${navHtml}
            <div class="spec-content p-2 flex-grow-1 overflow-auto">
              <div class="table-responsive">
                <table class="table table-bordered table-sm spec-table mb-0">
                  ${thead}
                  ${tbody}
                </table>
              </div>
            </div>
          </div>`;

        target.innerHTML = tableHtml;
      })
      .catch(err => {
        document.getElementById("specs").innerHTML = `<div class='text-danger'>読込エラー: ${err}</div>`;
      });
  </script>
</body>
</html>
