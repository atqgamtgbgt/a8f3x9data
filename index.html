<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSVビューア（output を読むだけ）</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif; margin: 16px; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    select, button { font-size: 14px; padding: 6px 10px; }
    .status { font-size: 12px; color: #666; }
    .wrap { margin-top: 12px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
    table { border-collapse: collapse; width: 100%; font-size: 13px; table-layout: fixed; }
    thead th { position: sticky; top: 0; background: #fafafa; z-index: 1; }
    th, td { border-bottom: 1px solid #eee; padding: 6px 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .scroller { overflow: auto; max-height: 75vh; }
    .hidden { display: none; }
    .error { color: #c00; font-weight: 600; }
    .ok { color: #0a0; }
  </style>
  <!-- 依存ゼロでも動くけど、CSVのクォート対応のために PapaParse を使う（1ファイル、CDNのみ） -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
</head>
<body>
  <h1>CSVビューア（output をそのまま表示）</h1>

  <div class="row">
    <label for="csvSelect">CSV を選択:</label>
    <select id="csvSelect"></select>
    <button id="reloadBtn" title="再読込（完全にキャッシュ無効）">再読込</button>
    <span id="status" class="status"></span>
  </div>

  <div id="error" class="error hidden"></div>

  <div class="wrap">
    <div class="scroller">
      <table id="table">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
/**
 * ここに “output 配下の CSV パス” を相対パスで列挙するだけ。
 * 例はあなたの構成に合わせて適宜増減してください。
 */
const CSV_FILES = [
  // ランキング系（例）
  "output/pipeline/autohome-ranking-csvs/autohome_ranking_with_image_urls_with_maker_with_maker_ja.csv",

  // コンフィグ系（例）
  "output/autohome/18/config_18.ja.csv",
  // "output/autohome/18/config_18.csv",

  // Koubei 等があれば追加
  // "output/koubei/12345/koubei_summary_12345.csv",
];

// ---- ここから下は触らなくてOK（“読むだけ”実装） ----

const $select = document.getElementById("csvSelect");
const $status = document.getElementById("status");
const $error  = document.getElementById("error");
const $thead  = document.querySelector("#table thead");
const $tbody  = document.querySelector("#table tbody");
const $reload = document.getElementById("reloadBtn");

// セレクトに一覧を詰める
CSV_FILES.forEach(p => {
  const opt = document.createElement("option");
  opt.value = p;
  opt.textContent = p;
  $select.appendChild(opt);
});

// キャッシュ完全無効でフェッチ（no-store + キャッシュバスター）
async function fetchCsvNoCache(path) {
  const url = `${path}?v=${Date.now()}`;
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) {
    throw new Error(`HTTP ${res.status} / ${res.statusText} @ ${path}`);
  }
  return await res.text();
}

function toTable(data) {
  // ヘッダー生成
  const header = data[0] || [];
  $thead.innerHTML = "";
  const trh = document.createElement("tr");
  header.forEach(h => {
    const th = document.createElement("th");
    th.title = h ?? "";
    th.textContent = h ?? "";
    trh.appendChild(th);
  });
  $thead.appendChild(trh);

  // 本文
  $tbody.innerHTML = "";
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    if (row.length === 1 && row[0] === "") continue; // 余分な空行はスキップ
    const tr = document.createElement("tr");
    for (let c = 0; c < header.length; c++) {
      const td = document.createElement("td");
      const v = (row[c] ?? "").toString();
      td.title = v;
      td.textContent = v;
      tr.appendChild(td);
    }
    $tbody.appendChild(tr);
  }
}

async function loadSelected() {
  const path = $select.value;
  $error.classList.add("hidden");
  $error.textContent = "";
  $status.textContent = `読込中… ${path}`;
  try {
    const csvText = await fetchCsvNoCache(path);
    const parsed = Papa.parse(csvText.trim(), { header: false });
    const rows = parsed.data || [];
    toTable(rows);
    $status.innerHTML = `OK: <span class="ok">${rows.length.toLocaleString()} 行</span>（${path}）`;
  } catch (e) {
    console.error(e);
    $thead.innerHTML = "";
    $tbody.innerHTML = "";
    $error.textContent = `読み込みエラー: ${e.message}`;
    $error.classList.remove("hidden");
    $status.textContent = "エラー";
  }
}

// イベント
$select.addEventListener("change", loadSelected);
$reload.addEventListener("click", loadSelected);

// 初期表示
if (CSV_FILES.length) {
  $select.value = CSV_FILES[0];
  loadSelected();
} else {
  $status.textContent = "CSV_FILES が空です。配列に output 配下の CSV パスを追加してください。";
}
</script>
</body>
</html>
