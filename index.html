<!DOCTYPE html>
<html lang="ja" data-bs-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>China Auto Dashboard</title>
  <link rel="icon" href="https://img.icons8.com/emoji/48/automobile.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
body {
  background-color: #f8f9fa;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
}

header {
  background: #0d6efd;
  color: #fff;
  padding: 12px;
  text-align: center;
  font-size: 1.3rem;
  font-weight: 700;
}

th {
  background-color: #f1f3f5;
}

.rank-up {
  color: #dc3545;
  font-weight: bold;
}

.rank-down {
  color: #0d6efd;
  font-weight: bold;
}

img.car-thumb {
  width: 80px;
  height: 60px;
  object-fit: cover;
  border-radius: 6px;
  background: #eee;
}

.price-jpy {
  font-size: 0.85rem;
  color: #6c757d;
}

.btn-spec,
.btn-story {
  font-size: 0.8rem;
  padding: 2px 6px;
  margin: 2px;
}
.spec-table tbody tr.sec-row .section-col {
  border-right: none !important;
  box-shadow: none !important;
}
/* section-fill ã®å·¦å´ã®ç¸¦ç·šã‚’æ¶ˆã™ */
.spec-table tbody tr.sec-row .section-fill {
  border-left: none !important;
  box-shadow: none !important;
}
/* é€šå¸¸ã®é …ç›®è¡Œ tdï¼ˆsection-row ä»¥å¤–ï¼‰ã®å·¦ç½«ç·šã‚’æ¶ˆã™ */
.spec-table tbody tr:not(.sec-row) td {
  border-left: none !important;
  box-shadow: inset 0 -1px 0 #dee2e6 !important;  /* ä¸‹ç·šã ã‘æ®‹ã™ */
}
/* ã‚«ãƒ©ãƒ åï¼ˆtheadï¼‰ã®å·¦ç½«ç·šã‚’æ¶ˆã™ */
.spec-table thead th:not(.sticky-col) {
  border-left: none !important;
  box-shadow: inset 0 0px 0 #dee2e6 !important; /* ä¸‹ç·šã ã‘æ®‹ã™ */
}

/* =====================================
   stickyï¼ˆPCï¼‹ã‚¹ãƒãƒ›å…±é€šï¼‰
===================================== */
.spec-table thead th {
  position: sticky;
  top: 0;
  z-index: 30;
  background: #fff;
  box-shadow: 0 2px 3px rgba(0, 0, 0, 0.08);
  vertical-align: middle !important;
  padding-top: 6px;
  padding-bottom: 6px;
}

.spec-table thead th.sticky-col {
  position: sticky;
  left: 0;
  z-index: 31;
  background: #fff;
}

.spec-table tbody th.item-col {
  position: sticky;
  left: 0;
  z-index: 12;
  background: #fff;
}

/* =====================================
   ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡Œï¼ˆz-index ã¯ JS ã§ä¸Šæ›¸ãï¼‰
===================================== */
.spec-table tbody tr.sec-row {
  height: 2.6em;
}

.spec-table tbody tr.sec-row .section-col {
  position: sticky;
  left: 0;
  top: var(--secOffset, 42px);
  z-index: 41;
  background: #f8f9fa;
  font-weight: 600;
}

.spec-table tbody tr.sec-row .section-fill {
  position: sticky;
  left: 180px;
  top: var(--secOffset, 42px);
  z-index: 39;
  background: #f8f9fa;
}

.spec-table tbody tr.sec-row .section-col,
.spec-table tbody tr.sec-row .section-fill {
  line-height: 2.6em;
  vertical-align: middle;
  white-space: nowrap;
}

/* =====================================
   èƒŒæ™¯é€ã‘é˜²æ­¢ãƒã‚¹ã‚¯ï¼ˆå…±é€šï¼‰
===================================== */
.spec-content::before {
  content: "";
  position: sticky;
  top: 0;
  left: 0;
  width: 100%;
  height: var(--secOffset, 42px);
  background: #fff;
  z-index: 25;
  pointer-events: none;
}

.spec-content::after {
  content: "";
  position: sticky;
  top: 0;
  left: 0;
  width: calc(180px + 0.5rem);
  height: 100%;
  background: #fff;
  z-index: 24;
  pointer-events: none;
}

/* =====================================
   PC ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
===================================== */
@media (min-width: 992px) {
  .spec-table-container {
    display: flex;
    align-items: flex-start;
    height: 80vh;
    background: #fff;
  }

  .spec-sidebar {
    position: sticky;
    top: 0;
    flex: 0 0 180px;
    height: 80vh;
    overflow-y: auto;
    background: #fff;
    border-right: 1px solid #dee2e6;
    padding: 8px;
  }

  .spec-content {
    flex: 1;
    overflow: hidden !important;
    height: 80vh;
    padding: 8px;
    position: relative;
    background: #fff;
    background-clip: padding-box;
  }

  .spec-content .table-responsive {
    position: relative;
    height: 100%;
    overflow: auto !important;
    cursor: grab;
    will-change: scroll-position;
  }

  .spec-content .table-responsive.active-drag {
    cursor: grabbing;
    user-select: none;
  }

  .spec-content .table-responsive.active-drag * {
    user-select: none;
    pointer-events: none;
  }

  .spec-table {
    position: relative;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 100%;
  }

  .spec-table tbody tr.sec-row .section-fill {
    left: 179px !important;
  }
}

/* =====================================
   ã‚¹ãƒãƒ›æœ€é©åŒ–ï¼ˆ576px ä»¥ä¸‹ï¼‰
===================================== */
@media (max-width: 576px) {

  /* --- è¡Œå…¨ä½“ã‚’ã‚«ãƒ¼ãƒ‰åŒ– --- */
  #carTable tbody tr {
    border-radius: 10px !important;
    padding: 10px 12px !important;
    margin: 12px 6px !important;
    background: #fff !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    border: 1px solid #dee2e6 !important;
    display: block;
    position: relative;
  }

  /* --- ãƒ˜ãƒƒãƒ€ãƒ¼å‰Šé™¤ï¼ˆç‹­ã„ãŸã‚ï¼‰ --- */
  #carTable thead {
    display: none;
  }

  /* --- å„ã‚»ãƒ«ã‚’ãƒ–ãƒ­ãƒƒã‚¯åŒ– --- */
  #carTable td {
    display: block;
    width: 100%;
    padding: 4px 0 !important;
    white-space: normal !important;
    text-align: left !important;
    border: none !important;
  }

  /* --- é †ä½ã‚»ãƒ«ï¼ˆ1åˆ—ç›®ï¼‰--- */
  #carTable td:nth-child(1) {
    position: absolute !important;
    top: 8px !important;
    left: 8px !important;
    padding: 4px 10px !important;
    border-radius: 6px !important;
    font-size: 0.9rem !important;
    font-weight: bold !important;
    color: #fff !important;
    background: rgba(13, 110, 253, 0.9) !important;
    z-index: 10 !important;
    display: inline-block !important;
    width: auto !important;
    height: auto !important;
  }

  /* --- å¤‰å‹•ã‚»ãƒ«ï¼ˆ2åˆ—ç›®ï¼‰--- */
  #carTable td:nth-child(2) {
    position: absolute !important;
    top: 8px !important;
    left: 60px !important;
    padding: 4px 8px !important;
    border-radius: 6px !important;
    font-size: 0.85rem !important;
    color: #fff !important;
    z-index: 10 !important;
    display: inline-block !important;
    width: auto !important;
    height: auto !important;
  }

  /* å¤‰å‹•ãªã—ã®å ´åˆã¯éè¡¨ç¤º */
  #carTable td:nth-child(2):empty {
    display: none !important;
  }

  /* å¤‰å‹•ãŒä¸Šæ˜‡ã®å ´åˆ */
  #carTable td:nth-child(2):has(.rank-up) {
    background: rgba(220, 53, 69, 0.9) !important;
  }

  /* å¤‰å‹•ãŒä¸‹é™ã®å ´åˆ */
  #carTable td:nth-child(2):has(.rank-down) {
    background: rgba(13, 110, 253, 0.9) !important;
  }

  /* å¤‰å‹•ãªã—ã®å ´åˆ */
  #carTable td:nth-child(2):not(:has(.rank-up)):not(:has(.rank-down)) {
    background: rgba(108, 117, 125, 0.9) !important;
  }

  /* --- ç”»åƒã‚»ãƒ« --- */
  #carTable td:nth-child(3) {
    float: left;
    width: 120px !important;
    text-align: center;
    position: relative !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    height: 120px !important;
    padding: 0 !important;
    margin-top: 30px !important;
  }

  #carTable td:nth-child(3) img.car-thumb {
    max-height: 100px !important;
    max-width: 110px !important;
    object-fit: contain !important;
  }

  /* --- ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã‚’å³å´ã¸ --- */
  #carTable td:nth-child(4),
  #carTable td:nth-child(5),
  #carTable td:nth-child(6),
  #carTable td:nth-child(7),
  #carTable td:nth-child(8) {
    margin-left: 135px !important;
    display: block;
    padding-top: 2px !important;
    padding-bottom: 2px !important;
    font-size: 0.92rem !important;
  }

  /* è»Šåã‚’å¤§ãã */
  #carTable td:nth-child(4) {
    font-weight: 600;
    font-size: 1rem !important;
    padding-top: 32px !important;
    margin-bottom: 2px !important;
  }

  /* ãƒœã‚¿ãƒ³ */
  #carTable td:nth-child(8) {
    margin-top: 8px !important;
  }

  #carTable td:nth-child(8) button {
    min-width: 70px;
    padding: 4px 8px !important;
    margin-right: 6px !important;
    margin-bottom: 4px !important;
    font-size: 0.85rem !important;
  }
}

/* =====================================
   stickyï¼‹ã‚»ãƒ¬ã‚¯ãƒˆãƒˆã‚°ãƒ«ï¼ˆã‚¹ãƒãƒ›991pxä»¥ä¸‹ï¼‰
===================================== */
@media (max-width: 991px) {
  .spec-content .table-responsive {
    max-height: 70vh;
    overflow: auto !important;
  }

  #csvModal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
  }

  #csvModal .modal-title {
    display: none;
  }

  #csvModal .section-toggle {
    flex: 1;
    order: 1;
  }

  #csvModal .btn-open-full {
    order: 2;
  }

  #csvModal .btn-close {
    order: 3;
  }

  .section-toggle {
    position: static;
    transform: none;
    width: auto;
    padding: 0;
    pointer-events: auto;
  }

  .section-toggle select {
    width: auto;
    min-width: 200px;
    max-width: 60vw;
    margin: 0;
    display: block;
    pointer-events: auto;
    background: #fff;
  }

  .spec-table thead th.sticky-col,
  .spec-table tbody th.item-col {
    min-width: 100px !important;
    max-width: 100px !important;
    width: 100px !important;
    font-size: 0.85rem;
    padding: 4px 6px !important;
  }

  .spec-table tbody tr.sec-row .section-col {
    min-width: 100px !important;
    max-width: 100px !important;
    width: 100px !important;
    font-size: 0.9rem;
    background: #f8f9fa !important;
    box-shadow: 150px 0 0 0 #f8f9fa !important;
  }

  .spec-table tbody tr.sec-row .section-fill {
    left: 99px !important;
  }

  .spec-content::after {
    width: calc(100px + 0.5rem) !important;
  }
}

/* =====================================
   ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒœãƒ¼ãƒ€ãƒ¼ã‚’box-shadowã§å®Ÿè£…
===================================== */
.spec-table {
  position: relative;
  border-collapse: separate;
  border-spacing: 0;
  min-width: 100%;
}

/* å…¨ã¦ã®ã‚»ãƒ«ã«box-shadowã§ãƒœãƒ¼ãƒ€ãƒ¼ã‚’é©ç”¨ */
.spec-table td,
.spec-table th {
  box-shadow: 
    inset 0px 0 0 #dee2e6,
    inset 0 0px 0 #dee2e6;
}

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡Œã¯ä¸‹ã®ãƒœãƒ¼ãƒ€ãƒ¼ã®ã¿ï¼ˆå³å´ã®ç¸¦ç·šã‚’å‰Šé™¤ï¼‰ */
.spec-table tbody tr.sec-row .section-col {
  box-shadow: 
    inset 0 -1px 0 #dee2e6 !important;
}

.spec-table tbody tr.sec-row .section-fill {
  box-shadow: 
    inset 0 -1px 0 #dee2e6 !important;
}

/* =====================================
   ãã®ä»–èª¿æ•´
===================================== */
.spec-content.p-2 {
  padding: 0 !important;
  background: #fff !important;
}

.spec-table tbody tr:not(.sec-row) td {
  position: relative;
  z-index: 10;
  background: #fff !important;
}

/* =====================================
   å…¨ç”»é¢è¡¨ç¤ºãƒœã‚¿ãƒ³
===================================== */
.btn-open-full {
  width: auto;
  height: auto;
  padding: 0;
  margin: 0 0.5rem 0 0;
  background: transparent;
  border: none;
  opacity: 0.8;
  cursor: pointer;
  flex-shrink: 0;
  font-size: 1.2rem;
  color: #000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.btn-open-full:hover {
  opacity: 1;
}
.btn-open-full i {
  pointer-events: none;
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒœã‚¿ãƒ³é…ç½® */
#csvModal .modal-header {
  display: flex;
  align-items: center;
}

#csvModal .modal-header .modal-title {
  flex: 1;
  margin-right: auto;
}

#csvModal .modal-header .btn-open-full,
#csvModal .modal-header .btn-close {
  order: 10;
}

@media (min-width: 992px) {
  #csvModal .modal-title {
    display: block !important;
  }
}
</style>
<body>
  <header>ğŸš— China Auto Dashboard</header>

  <div class="container mt-3">
    <div id="status" class="alert alert-info py-2">Autohome CSV èª­ã¿è¾¼ã¿ä¸­...</div>

    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle" id="carTable">
        <thead>
          <tr>
            <th style="width:80px">é †ä½</th>
            <th style="width:80px">å¤‰å‹•</th>
            <th style="width:100px">ç”»åƒ</th>
            <th>è»Šå</th>
            <th>ãƒ¡ãƒ¼ã‚«ãƒ¼</th>
            <th style="width:110px">å°æ•°</th>
            <th style="width:160px">ä¾¡æ ¼</th>
            <th style="width:100px">æƒ…å ±</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ä»•æ§˜ -->
  <div class="modal fade" id="csvModal" tabindex="-1" aria-labelledby="csvModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="csvModalLabel">è»Šä¸¡ä»•æ§˜</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
        </div>
        <div class="modal-body">
          <div id="csvContent" class="table-responsive"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: å£ã‚³ãƒŸ -->
  <div class="modal fade" id="storyModal" tabindex="-1" aria-labelledby="storyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="storyModalLabel">å£ã‚³ãƒŸæ¦‚è¦</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
        </div>
        <div class="modal-body">
          <div id="storyContent">èª­è¾¼ä¸­...</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>const RAW_BASE = "https://raw.githubusercontent.com/atqgamtgbgt/a8f3x9data/main/";
const CSV_PATH = `${RAW_BASE}output/pipeline/autohome-ranking-csvs/autohome_ranking_with_image_urls_with_maker_with_maker_ja.csv?v=${Date.now()}`;
const IMG_BASE = `${RAW_BASE}output/pipeline/autohome-ranking-images/autohome_images/`;
let cnyToJpy = 20;

async function fetchRate() {
  try {
    const res = await fetch("https://api.exchangerate.host/latest?base=CNY&symbols=JPY");
    const data = await res.json();
    if (data?.rates?.JPY) cnyToJpy = data.rates.JPY;
  } catch {
    cnyToJpy = 20;
  }
}

function convertToJPY(priceStr) {
  if (!priceStr) return "";
  const m = priceStr.match(/([\d.]+)-([\d.]+)ä¸‡/);
  if (!m) return "";
  const low = parseFloat(m[1]) * cnyToJpy * 10000;
  const high = parseFloat(m[2]) * cnyToJpy * 10000;
  const fmt = (x) => (x / 10000).toFixed(1);
  return `ï¼ˆç´„${fmt(low)}ã€œ${fmt(high)}ä¸‡å††ï¼‰`;
}

function imgTag(rankStr, model, imageUrl) {
  const fullPath = imageUrl && imageUrl.startsWith("/autohome_images/")
    ? `${RAW_BASE}output/pipeline/autohome-ranking-images${imageUrl}?v=${Date.now()}`
    : (imageUrl || `${IMG_BASE}${rankStr}_${model}.png?v=${Date.now()}`);
  return `<img class="car-thumb" src="${fullPath}" alt="${model}" onerror="this.style.visibility='hidden';" />`;
}

async function main() {
  await fetchRate();
  try {
    const res = await fetch(CSV_PATH, { cache: "no-store" });
    if (!res.ok) throw new Error(res.statusText);
    const text = await res.text();
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
    if (!parsed.meta.fields?.includes("rank")) throw new Error("rank åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    renderTable(parsed.data);
    ok(`âœ… æœ€æ–°CSV èª­ã¿è¾¼ã¿æˆåŠŸ (${parsed.data.length}ä»¶)`);
  } catch (err) {
    fail("CSV èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err.message);
  }
}

function renderTable(data) {
  const tbody = document.querySelector("#carTable tbody");
  tbody.innerHTML = "";
  data.forEach(r => {
    const rankStr = String(r.rank).padStart(3, "0");
    const diff = Number(r.delta_vs_last_month || 0);
    const diffHtml = diff > 0
      ? `<span class="rank-up">â–²${diff}</span>`
      : diff < 0
      ? `<span class="rank-down">â–¼${-diff}</span>`
      : "";
    const link = r.link || "";
    const carId = link.match(/(\d+)/)?.[1] || "";
    const name = r.global_name || r.name || "";
    const price = (r.price || "") + " å…ƒ";
    const priceJPY = convertToJPY(r.price || "");
    const maker = r.manufacturer_ja || r.manufacturer || "";
    const units = r.units || "";
    const specBtn = carId
      ? `<button class="btn btn-outline-primary btn-sm btn-spec" onclick="showConfigCsv('${carId}','${name}')">ä»•æ§˜</button>`
      : "";
    const storyBtn = carId
      ? `<button class="btn btn-outline-secondary btn-sm btn-story" onclick="showStory('${carId}','${name}')">å£ã‚³ãƒŸ</button>`
      : "";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="rank-badge">${r.rank}</td>
      <td class="diff-badge">${diffHtml}</td>
      <td>${imgTag(rankStr, name, r.image_url)}</td>
      <td><a href="${link}" target="_blank" rel="noopener">${name}</a></td>
      <td>${maker}</td>
      <td>${units}</td>
      <td>${price}<br><span class="price-jpy">${priceJPY}</span></td>
      <td>${specBtn}${storyBtn}</td>`;
    tbody.appendChild(tr);
  });
}

function ok(msg){
  const s=document.getElementById("status");
  s.className="alert alert-success py-2";
  s.textContent=msg;
}
function fail(msg){
  const s=document.getElementById("status");
  s.className="alert alert-danger py-2";
  s.textContent=msg;
}

function openFullSpec() {
  const html = document.getElementById("csvContent").innerHTML;
  const title = document.getElementById("csvModalLabel").textContent;
  
  // å®Œå…¨ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’å–å¾—
  const allStyles = document.querySelector('style').textContent;
  
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚»ãƒ¬ã‚¯ãƒˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
  const selectEl = document.getElementById("sectionSelect");
  const selectOptions = selectEl ? selectEl.innerHTML : '';
  
  // HTMLå…¨ä½“ã‚’ä½œæˆï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ§‹é€ ã‚’å®Œå…¨å†ç¾ï¼‰
  const fullHTML = `
    <!DOCTYPE html>
    <html lang="ja">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
        <title>${title}</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
        <style>
          ${allStyles}
          body { 
            margin: 0;
            padding: 0;
            background: #f8f9fa;
            overflow: hidden;
          }
          .fullscreen-modal-header {
            background: #fff;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            position: sticky;
            top: 0;
            z-index: 1055;
          }
          .fullscreen-modal-header h5 {
            margin: 0;
            font-size: 1.25rem;
            flex: 1;
          }
          .fullscreen-modal-body {
            height: calc(100vh - 60px);
            overflow: auto;
            background: #fff;
          }
          .close-fullscreen {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            opacity: 0.5;
            cursor: pointer;
            padding: 0;
            width: 1em;
            height: 1em;
            line-height: 1;
          }
          .close-fullscreen:hover {
            opacity: 1;
          }
          /* iOS Braveå¯¾ç­– */
          .spec-table thead th {
            position: -webkit-sticky !important;
            position: sticky !important;
          }
          .spec-table thead th.sticky-col {
            position: -webkit-sticky !important;
            position: sticky !important;
          }
          .spec-table tbody th.item-col {
            position: -webkit-sticky !important;
            position: sticky !important;
          }
          .spec-table tbody tr.sec-row .section-col {
            position: -webkit-sticky !important;
            position: sticky !important;
          }
          .spec-table tbody tr.sec-row .section-fill {
            position: -webkit-sticky !important;
            position: sticky !important;
          }
        </style>
      </head>
      <body>
        <div class="fullscreen-modal-header" id="modalHeader">
          <h5 id="modalTitle">${title}</h5>
          <button type="button" class="close-fullscreen" onclick="window.close()" aria-label="é–‰ã˜ã‚‹">Ã—</button>
        </div>
        <div class="fullscreen-modal-body">
          ${html}
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"><\/script>
        <script>
          setTimeout(() => {
            const scrollArea = document.querySelector("#specScrollArea .table-responsive") || document.getElementById("specScrollArea");
            if (!scrollArea) return;
            
            const theadEl = scrollArea.querySelector(".spec-table thead");
            const theadH = theadEl ? Math.ceil(theadEl.getBoundingClientRect().height) : 0;
            
            if (scrollArea) {
              scrollArea.style.setProperty("--secOffset", theadH + "px");
              
              // z-indexã‚’å†è¨­å®šï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã¨åŒã˜ï¼‰
              document.querySelectorAll('.spec-table tbody tr.sec-row').forEach((row, index) => {
                const baseZ = 100;
                const colEl = row.querySelector('.section-col');
                const fillEl = row.querySelector('.section-fill');
                if (colEl) colEl.style.zIndex = baseZ + index * 2 + 1;
                if (fillEl) fillEl.style.zIndex = baseZ + index * 2;
              });
            }
            
            const modalHeader = document.getElementById('modalHeader');
            const closeBtn = modalHeader.querySelector('.close-fullscreen');
            
            // æ—¢å­˜ã®è¦ç´ ã‚’å‰Šé™¤
            const existingToggle = modalHeader.querySelector('.section-toggle');
            if (existingToggle) existingToggle.remove();
            const existingFullBtn = modalHeader.querySelector('.btn-open-full');
            if (existingFullBtn) existingFullBtn.remove();
            
            // ã‚¹ãƒãƒ›æ™‚ï¼šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚»ãƒ¬ã‚¯ãƒˆã‚’è¿½åŠ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã¨åŒã˜å‡¦ç†ï¼‰
            if (window.innerWidth <= 991) {
              const modalTitle = document.getElementById('modalTitle');
              if (modalTitle) modalTitle.style.display = 'none';
              
              const toggleDiv = document.createElement('div');
              toggleDiv.className = 'section-toggle';
              toggleDiv.innerHTML = '<select id="sectionSelect">${selectOptions}</select>';
              modalHeader.insertBefore(toggleDiv, closeBtn);
              
              // ã‚¹ãƒãƒ›æ™‚ã®å¹…èª¿æ•´ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã¨åŒã˜ï¼‰
              document.querySelectorAll('.spec-table tbody th.item-col:not(.section-col)').forEach(el => {
                el.style.minWidth = '100px';
                el.style.maxWidth = '100px';
                el.style.width = '100px';
              });
              
              document.querySelectorAll('.spec-table tbody tr.sec-row th.section-col').forEach(el => {
                el.style.minWidth = '100px';
                el.style.maxWidth = '100px';
                el.style.width = '100px';
              });
              
              document.querySelectorAll('.spec-table tbody tr.sec-row .section-fill').forEach(el => {
                el.style.left = '99px';
              });
            }
            
            const headerHeight = theadH;
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã¨åŒã˜ï¼‰
            document.querySelectorAll(".spec-sidebar a").forEach(a=>{
              a.addEventListener("click",ev=>{
                ev.preventDefault();
                const id=a.getAttribute("href");
                const el=document.querySelector(id);
                if(el && scrollArea){
                  const offset = el.offsetTop - headerHeight;
                  scrollArea.scrollTo({top:offset,behavior:"smooth"});
                }
              });
            });
            
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚»ãƒ¬ã‚¯ãƒˆï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã¨åŒã˜ï¼‰
            const select=document.getElementById("sectionSelect");
            if(select){
              select.addEventListener("change",e=>{
                const id=e.target.value;
                const el=document.querySelector(id);
                if(el && scrollArea){
                  const offset = el.offsetTop - headerHeight;
                  scrollArea.scrollTo({top:offset,behavior:"smooth"});
                }
              });
            }
          }, 300);
        <\/script>
      </body>
    </html>
  `;
  
  // Blob URLã‚’ä½¿ç”¨
  try {
    const blob = new Blob([fullHTML], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const w = window.open(url, '_blank');
    
    if (!w || w.closed || typeof w.closed == 'undefined') {
      throw new Error('Popup blocked');
    }
    
    setTimeout(() => URL.revokeObjectURL(url), 10000);
  } catch (e) {
    const dataUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(fullHTML);
    const w = window.open(dataUrl, '_blank');
    
    if (!w || w.closed || typeof w.closed == 'undefined') {
      alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚\n\nBraveã®å ´åˆï¼š\nã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®ç›¾ã‚¢ã‚¤ã‚³ãƒ³ > ã‚µã‚¤ãƒˆè¨­å®š > ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ ã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´');
    }
  }
}

/* ==== showConfigCsv é–‹å§‹ ==== */
function showConfigCsv(carId, title) {
  const path = `output/autohome/${carId}/config_${carId}.ja.csv?v=${Date.now()}`;
  const target = document.getElementById("csvContent");
  document.getElementById("csvModalLabel").textContent = `è»Šä¸¡ä»•æ§˜ï¼ˆ${title} | ID:${carId}ï¼‰`;
  target.innerHTML = "èª­è¾¼ä¸­...";
  Papa.parse(path, {
    download: true,
    header: false,
    skipEmptyLines: false,
    complete: (res) => {
      const rows = (res.data || []).map(r => (r || []).map(v => (v ?? "").toString().trim()));
      if (!rows.length) { target.innerHTML = "<div class='text-danger'>CSVãŒç©ºã§ã™ã€‚</div>"; return; }

      const headerIdx = rows.findIndex(r => r.some(v => /^é …ç›®(_ja)?$/.test((v || "").trim())));
      if (headerIdx === -1) { target.innerHTML = "<div class='text-danger'>ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>"; return; }

      const headerRow = rows[headerIdx];
      const idxSecJa  = headerRow.findIndex(v => (v || "").trim() === "ã‚»ã‚¯ã‚·ãƒ§ãƒ³_ja");
      const idxSec    = headerRow.findIndex(v => (v || "").trim() === "ã‚»ã‚¯ã‚·ãƒ§ãƒ³");
      const secIdx    = (idxSecJa !== -1 ? idxSecJa : idxSec);
      const idxItemJa = headerRow.findIndex(v => (v || "").trim() === "é …ç›®_ja");
      const idxItem   = headerRow.findIndex(v => (v || "").trim() === "é …ç›®");
      const itemIdx   = (idxItemJa !== -1 ? idxItemJa : idxItem);
      const modelStart = Math.max(secIdx, itemIdx) + 1;
      const modelHeaders = headerRow.slice(modelStart);
      const dataRows = rows.slice(headerIdx + 1);

      const grouped = [];
      let currentSection = "";
      for (const r of dataRows) {
        const sec = (r[secIdx] || "").trim();
        if (sec && sec.toLowerCase() !== "nan") currentSection = sec;
        if (!currentSection) continue;
        const item = (r[itemIdx] || "").trim();
        if (!item || /^(ã‚»ã‚¯ã‚·ãƒ§ãƒ³|ã‚»ã‚¯ã‚·ãƒ§ãƒ³_ja|é …ç›®|é …ç›®_ja)$/i.test(item)) continue;
        const cols = r.slice(modelStart);
        if (!grouped.length || grouped[grouped.length - 1].section !== currentSection)
          grouped.push({ section: currentSection, rows: [] });
        grouped[grouped.length - 1].rows.push([item, ...cols]);
      }

      // === ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ ===
      let options = "";
      for (const g of grouped) {
        options += `<option value="#sec_${g.section.replace(/[ï¼\/]/g,"_").replace(/\s+/g,"_")}">${g.section}</option>`;
      }

      const navHtml = `
        <div class="spec-sidebar d-none d-lg-block">
          <ul class="list-unstyled m-0 p-0">
            ${grouped.map(g => `<li><a href="#sec_${g.section.replace(/[ï¼\/]/g,"_").replace(/\s+/g,"_")}" class="text-decoration-none d-block py-1">${g.section}</a></li>`).join("")}
          </ul>
        </div>`;

      // === tbodyç”Ÿæˆ ===
      const thead = `<thead><tr><th class="sticky-col" style="min-width:180px;"></th>${modelHeaders.map(h=>`<th>${h}</th>`).join("")}</tr></thead>`;
      let tbody="<tbody>";
      for(const g of grouped){
        const id=`sec_${g.section.replace(/[ï¼\/]/g,"_").replace(/\s+/g,"_")}`;
        tbody+=`
          <tr id="${id}" class="sec-row" data-section="${g.section}">
            <th class="item-col section-col">â–¼ ${g.section}</th>
            <td colspan="${modelHeaders.length}" class="section-fill"></td>
          </tr>`;
        for(const row of g.rows){
          const item=row[0]||"";
          const cells=row.slice(1).map(v=>`<td style="white-space:pre-line;">${(v||"").replace(/^nan$/i,"")}</td>`).join("");
          tbody+=`<tr><th class="item-col">${item}</th>${cells}</tr>`;
        }
      }
      tbody+="</tbody>";

      const tableHtml=`
        <div class="spec-table-container d-flex">
          ${navHtml}
          <div class="spec-content p-2 flex-grow-1 overflow-auto" id="specScrollArea">
            <div class="table-responsive">
              <table class="table table-bordered table-sm spec-table mb-0">
                ${thead}${tbody}
              </table>
            </div>
          </div>
        </div>`;
      target.innerHTML=tableHtml;
      
      // === ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒœã‚¿ãƒ³ç®¡ç†ï¼ˆå¢—æ®–é˜²æ­¢ï¼‰ ===
      const modalHeader = document.querySelector('#csvModal .modal-header');
      const closeBtn = modalHeader.querySelector('.btn-close');
      
      // æ—¢å­˜ã®è¦ç´ ã‚’å…¨ã¦å‰Šé™¤
      const existingToggle = modalHeader.querySelector('.section-toggle');
      if (existingToggle) existingToggle.remove();
      const existingFullBtn = modalHeader.querySelector('.btn-open-full');
      if (existingFullBtn) existingFullBtn.remove();
      
      // ã‚¹ãƒãƒ›æ™‚ï¼šã‚»ãƒ¬ã‚¯ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 
      if (window.innerWidth <= 991) {
        const toggleDiv = document.createElement('div');
        toggleDiv.className = 'section-toggle';
        toggleDiv.innerHTML = `<select id="sectionSelect">${options}</select>`;
        modalHeader.insertBefore(toggleDiv, closeBtn);
      }
      
      // === å…¨ç”»é¢è¡¨ç¤ºãƒœã‚¿ãƒ³ã®è¿½åŠ ï¼ˆPCãƒ»ã‚¹ãƒãƒ›å…±é€šï¼‰ ===
      const fullBtn = document.createElement("button");
      fullBtn.className = "btn-open-full";
      fullBtn.setAttribute("title", "å…¨ç”»é¢è¡¨ç¤º");
      fullBtn.innerHTML = '<i class="fa-solid fa-expand"></i>';
      fullBtn.onclick = () => openFullSpec();
      modalHeader.insertBefore(fullBtn, closeBtn);

      // === ã‚¹ãƒãƒ›æ™‚ã®å¹…èª¿æ•´ ===
      if (window.innerWidth <= 991) {
        document.querySelectorAll('.spec-table tbody th.item-col:not(.section-col)').forEach(el => {
          el.style.minWidth = '100px';
          el.style.maxWidth = '100px';
          el.style.width = '100px';
        });
        
        document.querySelectorAll('.spec-table tbody tr.sec-row th.section-col').forEach(el => {
          el.style.minWidth = '200px';
          el.style.maxWidth = '200px';
          el.style.width = '200px';
        });
        
        document.querySelectorAll('.spec-table tbody tr.sec-row .section-fill').forEach(el => {
          el.style.left = '199px';
        });
      }

      // âœ… å‹•çš„z-indexè¨­å®š
      document.querySelectorAll('.spec-table tbody tr.sec-row').forEach((row, index) => {
        const baseZ = 100;
        const colEl = row.querySelector('.section-col');
        const fillEl = row.querySelector('.section-fill');
        if (colEl) colEl.style.zIndex = baseZ + index * 2 + 1;
        if (fillEl) fillEl.style.zIndex = baseZ + index * 2;
      });

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      const modal = new bootstrap.Modal(document.getElementById("csvModal"));
      modal.show();

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå®Œå…¨ã«è¡¨ç¤ºã•ã‚ŒãŸå¾Œã«é«˜ã•ã‚’è¨ˆç®—
      document.getElementById("csvModal").addEventListener('shown.bs.modal', function () {
        const scrollArea =
          document.querySelector("#specScrollArea .table-responsive")?.scrollHeight > 0
            ? document.querySelector("#specScrollArea .table-responsive")
            : document.getElementById("specScrollArea");
        const theadEl = scrollArea?.querySelector(".spec-table thead");
        const theadH = theadEl ? Math.ceil(theadEl.getBoundingClientRect().height) : 0;
        if (scrollArea) scrollArea.style.setProperty("--secOffset", theadH + "px");
        const headerHeight = theadH;

        // âœ… ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½ã‚’è¿½åŠ ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
        let isDown = false;
        let startX;
        let startY;
        let scrollLeft;
        let scrollTop;

        scrollArea.addEventListener('mousedown', (e) => {
          // ãƒªãƒ³ã‚¯ã‚„ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
          if (e.target.tagName === 'A' || e.target.closest('a') || e.target.tagName === 'BUTTON') return;
          
          isDown = true;
          scrollArea.classList.add('active-drag');
          startX = e.pageX - scrollArea.offsetLeft;
          startY = e.pageY - scrollArea.offsetTop;
          scrollLeft = scrollArea.scrollLeft;
          scrollTop = scrollArea.scrollTop;
          
          // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–
          scrollArea.style.scrollBehavior = 'auto';
        });

        scrollArea.addEventListener('mouseleave', () => {
          isDown = false;
          scrollArea.classList.remove('active-drag');
        });

        scrollArea.addEventListener('mouseup', () => {
          isDown = false;
          scrollArea.classList.remove('active-drag');
        });

        scrollArea.addEventListener('mousemove', (e) => {
          if (!isDown) return;
          e.preventDefault();
          const x = e.pageX - scrollArea.offsetLeft;
          const y = e.pageY - scrollArea.offsetTop;
          const walkX = (x - startX);
          const walkY = (y - startY);
          
          // requestAnimationFrameã‚’ä½¿ç”¨ã—ã¦ã‚¹ãƒ ãƒ¼ã‚ºã«
          requestAnimationFrame(() => {
            scrollArea.scrollLeft = scrollLeft - walkX;
            scrollArea.scrollTop = scrollTop - walkY;
          });
        });

        // åˆæœŸã‚«ãƒ¼ã‚½ãƒ«è¨­å®š
        scrollArea.style.cursor = 'grab';

        // âœ… ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ˜ãƒƒãƒ€ãƒ¼ç›´ä¸‹ã¸ç§»å‹•
        document.querySelectorAll(".spec-sidebar a").forEach(a=>{
          a.addEventListener("click",ev=>{
            ev.preventDefault();
            scrollArea.style.scrollBehavior = 'smooth';
            const id=a.getAttribute("href");
            const el=document.querySelector(id);
            if(el && scrollArea){
              const offset = el.offsetTop - headerHeight;
              scrollArea.scrollTo({top:offset,behavior:"smooth"});
            }
          });
        });

        // âœ… ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚»ãƒ¬ã‚¯ãƒˆã§ã‚‚åŒæ§˜ã«ç§»å‹•
        const select=document.getElementById("sectionSelect");
        if(select){
          select.addEventListener("change",e=>{
            scrollArea.style.scrollBehavior = 'smooth';
            const id=e.target.value;
            const el=document.querySelector(id);
            if(el && scrollArea){
              const offset = el.offsetTop - headerHeight;
              scrollArea.scrollTo({top:offset,behavior:"smooth"});
            }
          });
        }
      }, { once: true });
    },
    error:(err)=>{target.textContent="èª­ã¿è¾¼ã¿å¤±æ•—: "+err.message;}
  });
}

/* ==== å£ã‚³ãƒŸãƒ‡ãƒ¼ã‚¿ ==== */
async function showStory(carId,title){
  const path=`output/koubei/${carId}/story.txt?v=${Date.now()}`;
  const target=document.getElementById("storyContent");
  document.getElementById("storyModalLabel").textContent=`å£ã‚³ãƒŸæ¦‚è¦ï¼ˆ${title} | ID:${carId}ï¼‰`;
  target.textContent="èª­è¾¼ä¸­...";
  try{
    const res=await fetch(path,{cache:"no-store"});
    if(!res.ok)throw new Error("Not found");
    let text=await res.text();
    text=text.replace(/```/g,"");
    text=text.replace(/^### (.*)$/gm,"<h6 class='mt-3 fw-bold'>$1</h6>");
    text=text.replace(/\*\*(.*?)\*\*/g,"<b>$1</b>");
    text=text.replace(/\r?\n/g,"<br>");
    text=text.replace(/(<br>\s*){2,}/g,"<br><br>");
    target.innerHTML=`<div style="white-space:normal; line-height:1.7;">${text}</div>`;
  }catch{
    target.innerHTML="<div class='text-danger'>å£ã‚³ãƒŸãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>";
  }
  new bootstrap.Modal(document.getElementById("storyModal")).show();
}

main();
</script>


</body>
</html>
