<!DOCTYPE html>
<html lang="ja" data-bs-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>China Auto Dashboard</title>
  <link rel="icon" href="https://img.icons8.com/emoji/48/automobile.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { background-color: var(--bs-body-bg); font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif; }
    header { background: #0d6efd; color: #fff; padding: 12px; text-align: center; font-size: 1.3rem; font-weight: 700; }
    th { background-color: var(--bs-tertiary-bg); }
    .rank-up { color: #dc3545; font-weight: bold; }
    .rank-down { color: #0d6efd; font-weight: bold; }
    img.car-thumb { width: 80px; height: 60px; object-fit: cover; border-radius: 6px; background:#eee; }
    .price-jpy { font-size: 0.85rem; color: #6c757d; }
    .btn-spec, .btn-story { font-size: 0.8rem; padding: 2px 6px; margin: 2px; }

    .spec-sidebar { flex: 0 0 180px; border-right: 1px solid var(--bs-border-color); background: var(--bs-body-bg); position: sticky; top: 0; max-height: 80vh; overflow: auto; }
    .spec-content thead th { position: sticky; top: 0; background: var(--bs-body-bg); z-index: 1; }
    .sec-row th { background: var(--bs-tertiary-bg); position: sticky; top: 38px; z-index: 1; }
    .item-col { background: var(--bs-secondary-bg); min-width: 180px; }
    .spec-content table td, .spec-content table th { vertical-align: middle; }

    .section-toggle { display: none; position: sticky; top: 0; z-index: 1056; background: var(--bs-body-bg); border-bottom: 1px solid var(--bs-border-color); padding: 6px; }
    @media (max-width: 768px) {
      .spec-sidebar { display: none; }
      .section-toggle { display: block; }
    }
  </style>
</head>
<body>
  <header>ğŸš— China Auto Dashboard</header>

  <div class="container mt-3">
    <div id="status" class="alert alert-info py-2">Autohome CSV èª­ã¿è¾¼ã¿ä¸­...</div>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle" id="carTable">
        <thead>
          <tr>
            <th style="width:80px">é †ä½</th><th style="width:80px">å¤‰å‹•</th><th style="width:100px">ç”»åƒ</th>
            <th>è»Šå</th><th>ãƒ¡ãƒ¼ã‚«ãƒ¼</th><th style="width:110px">å°æ•°</th><th style="width:160px">ä¾¡æ ¼</th><th style="width:100px">æƒ…å ±</th>
          </tr>
        </thead><tbody></tbody>
      </table>
    </div>
  </div>

  <div class="modal fade" id="csvModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="csvModalLabel">è»Šä¸¡ä»•æ§˜</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><div id="csvContent" class="table-responsive"></div></div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="storyModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="storyModalLabel">å£ã‚³ãƒŸæ¦‚è¦</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><div id="storyContent">èª­è¾¼ä¸­...</div></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const RAW_BASE="https://raw.githubusercontent.com/atqgamtgbgt/a8f3x9data/main/";
    const CSV_PATH=`${RAW_BASE}output/pipeline/autohome-ranking-csvs/autohome_ranking_with_image_urls_with_maker_with_maker_ja.csv?v=${Date.now()}`;
    const IMG_BASE=`${RAW_BASE}output/pipeline/autohome-ranking-images/autohome_images/`;
    let cnyToJpy=20;

    async function fetchRate(){try{const r=await fetch("https://api.exchangerate.host/latest?base=CNY&symbols=JPY");const j=await r.json();if(j?.rates?.JPY)cnyToJpy=j.rates.JPY;}catch{cnyToJpy=20;}}
    function convertToJPY(s){if(!s)return"";const m=s.match(/([\d.]+)-([\d.]+)ä¸‡/);if(!m)return"";const f=x=>(x/10000).toFixed(1);return`ï¼ˆç´„${f(parseFloat(m[1])*cnyToJpy*10000)}ã€œ${f(parseFloat(m[2])*cnyToJpy*10000)}ä¸‡å††ï¼‰`;}
    function imgTag(r,m,u){const p=u&&u.startsWith("/autohome_images/")?`${RAW_BASE}output/pipeline/autohome-ranking-images${u}?v=${Date.now()}`:(u||`${IMG_BASE}${r}_${m}.png?v=${Date.now()}`);return`<img class="car-thumb" src="${p}" alt="${m}" onerror="this.style.visibility='hidden';"/>`;}

    async function main(){await fetchRate();try{const r=await fetch(CSV_PATH,{cache:"no-store"});if(!r.ok)throw new Error(r.statusText);const t=await r.text();const p=Papa.parse(t,{header:true,skipEmptyLines:true});if(!p.meta.fields?.includes("rank"))throw new Error("rank åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");renderTable(p.data);ok(`âœ… æœ€æ–°CSV èª­ã¿è¾¼ã¿æˆåŠŸ (${p.data.length}ä»¶)`);}catch(e){fail("CSV èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: "+e.message);}}
    function ok(m){const s=document.getElementById("status");s.className="alert alert-success py-2";s.textContent=m;}
    function fail(m){const s=document.getElementById("status");s.className="alert alert-danger py-2";s.textContent=m;}
    function renderTable(d){const tb=document.querySelector("#carTable tbody");tb.innerHTML="";d.forEach(r=>{const rank=String(r.rank).padStart(3,"0");const diff=Number(r.delta_vs_last_month||0);const diffH=diff>0?`<span class="rank-up">â–²${diff}</span>`:diff<0?`<span class="rank-down">â–¼${-diff}</span>`:"â€“";const link=r.link||"";const id=link.match(/(\d+)/)?.[1]||"";const name=r.global_name||r.name||"";const price=(r.price||"")+" å…ƒ";const pj=convertToJPY(r.price||"");const maker=r.manufacturer_ja||r.manufacturer||"";const units=r.units||"";const spec=id?`<button class="btn btn-outline-primary btn-sm" onclick="showConfigCsv('${id}','${name}')">ä»•æ§˜</button>`:"";const story=id?`<button class="btn btn-outline-secondary btn-sm" onclick="showStory('${id}','${name}')">å£ã‚³ãƒŸ</button>`:"";tb.insertAdjacentHTML("beforeend",`<tr><td>${r.rank}</td><td>${diffH}</td><td>${imgTag(rank,name,r.image_url)}</td><td><a href="${link}" target="_blank">${name}</a></td><td>${maker}</td><td>${units}</td><td>${price}<br><span class='price-jpy'>${pj}</span></td><td>${spec}${story}</td></tr>`);});}

    function showConfigCsv(id,title){
      const path=`output/autohome/${id}/config_${id}.ja.csv?v=${Date.now()}`;
      const t=document.getElementById("csvContent");
      document.getElementById("csvModalLabel").textContent=`è»Šä¸¡ä»•æ§˜ï¼ˆ${title} | ID:${id}ï¼‰`;t.innerHTML="èª­è¾¼ä¸­...";
      Papa.parse(path,{download:true,header:false,skipEmptyLines:false,complete:(res)=>{
        const rows=(res.data||[]).map(r=>(r||[]).map(v=>(v??"").toString().trim()));
        if(!rows.length){t.innerHTML="<div class='text-danger'>CSVãŒç©ºã§ã™ã€‚</div>";return;}
        const h=rows.findIndex(r=>r.some(v=>/^é …ç›®(_ja)?$/.test((v||"").trim())));
        if(h===-1){t.innerHTML="<div class='text-danger'>ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>";return;}
        const hr=rows[h];const si=hr.findIndex(v=>v==="ã‚»ã‚¯ã‚·ãƒ§ãƒ³"||v==="ã‚»ã‚¯ã‚·ãƒ§ãƒ³_ja");const ii=hr.findIndex(v=>v==="é …ç›®"||v==="é …ç›®_ja");
        const start=Math.max(si,ii)+1;const mh=hr.slice(start);const dr=rows.slice(h+1);
        const g=[];let cur="";
        for(const r of dr){const s=(r[si]||"").trim();if(s&&s.toLowerCase()!=="nan")cur=s;if(!cur)continue;const i=(r[ii]||"").trim();if(!i)continue;
          if(!g.length||g[g.length-1].section!==cur)g.push({section:cur,rows:[]});g[g.length-1].rows.push([i,...r.slice(start)]);}
        let nav="",opt="";
        for(const x of g){const idn=`sec_${x.section.replace(/[ï¼\/]/g,"_").replace(/\s+/g,"_")}`;nav+=`<a href="#${idn}" class="d-block py-1 text-decoration-none text-primary">${x.section}</a>`;opt+=`<option value="#${idn}">${x.section}</option>`;}
        const navHtml=`<div class="spec-sidebar p-2">${nav}</div>`;
        const toggleHtml=`<div class="section-toggle"><select id="sectionSelect">${opt}</select></div>`;
        const thead=`<thead><tr><th>é …ç›®</th>${mh.map(h=>`<th>${h}</th>`).join("")}</tr></thead>`;
        let tb="<tbody>";for(const x of g){const idn=`sec_${x.section.replace(/[ï¼\/]/g,"_").replace(/\s+/g,"_")}`;tb+=`<tr id="${idn}" class="sec-row"><th colspan="${1+mh.length}">â–¼ ${x.section}</th></tr>`;
          for(const r of x.rows){tb+=`<tr><th class='item-col'>${r[0]}</th>${r.slice(1).map(v=>`<td>${v.replace(/^nan$/i,"")}</td>`).join("")}</tr>`;}}tb+="</tbody>";
        t.innerHTML=`<div class="spec-table-container d-flex">${toggleHtml}${navHtml}<div class="spec-content p-2 flex-grow-1 overflow-auto"><div class="table-responsive"><table class="table table-bordered table-sm">${thead}${tb}</table></div></div></div>`;
        const sel=document.getElementById("sectionSelect");
        sel.addEventListener("change",e=>{const el=document.querySelector(e.target.value);if(el)el.scrollIntoView({behavior:"smooth",block:"start"});});
        const obs=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting)sel.value="#"+e.target.id;});},{root:t.querySelector(".spec-content"),threshold:0.4});
        g.forEach(x=>{const el=document.getElementById(`sec_${x.section.replace(/[ï¼\/]/g,"_").replace(/\s+/g,"_")}`);if(el)obs.observe(el);});
      },error:(e)=>{t.textContent="èª­ã¿è¾¼ã¿å¤±æ•—: "+e.message;}});
      new bootstrap.Modal(document.getElementById("csvModal")).show();
    }

    async function showStory(id,title){
      const p=`output/koubei/${id}/story.txt?v=${Date.now()}`;const t=document.getElementById("storyContent");
      document.getElementById("storyModalLabel").textContent=`å£ã‚³ãƒŸæ¦‚è¦ï¼ˆ${title} | ID:${id}ï¼‰`;t.textContent="èª­è¾¼ä¸­...";
      try{const r=await fetch(p,{cache:"no-store"});if(!r.ok)throw new Error();let txt=await r.text();
        txt=txt.replace(/```/g,"").replace(/^### (.*)$/gm,"<h6 class='mt-3 fw-bold'>$1</h6>").replace(/\*\*(.*?)\*\*/g,"<b>$1</b>").replace(/\r?\n/g,"<br>").replace(/(<br>\s*){2,}/g,"<br><br>");
        t.innerHTML=`<div style="white-space:normal;line-height:1.7;">${txt}</div>`;}catch{t.innerHTML="<div class='text-danger'>å£ã‚³ãƒŸãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>";}
      new bootstrap.Modal(document.getElementById("storyModal")).show();
    }
    main();
  </script>
</body>
</html>
